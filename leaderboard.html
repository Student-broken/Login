<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classement - Outil JDLM</title>
    <link rel="icon" href="https://raw.githubusercontent.com/Student-broken/student-broken.github.io/refs/heads/main/favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2980b9; --secondary-color: #2c3e50; --background-color: #f7f9fb;
            --widget-background: #ffffff; --text-color: #34495e; --footer-grey: #95a5a6;
            --shadow-header: 0 2px 4px rgba(0, 0, 0, 0.05); --shadow-widget: 0 8px 15px rgba(0, 0, 0, 0.08);
            --green: #27ae60; --red: #e74c3c; --grey: #7f8c8d;
        }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background-color: var(--background-color); color: var(--text-color); }
        .site-header-container { background-color: var(--widget-background); box-shadow: var(--shadow-header); border-bottom: 1px solid #e0e6eb; padding: 15px 0; position: relative; }
        .site-header { text-align: center; padding: 0; margin: 0; color: var(--secondary-color); font-size: 2.2em; font-family: 'Playfair Display', serif; }
        .back-arrow { position: absolute; top: 50%; left: 25px; transform: translateY(-50%); font-size: 2.2em; color: var(--secondary-color); text-decoration: none; transition: color 0.2s; }
        .back-arrow:hover { color: var(--primary-color); }
        .main-content { max-width: 900px; margin: 30px auto; padding: 0 20px; }
        .controls { display: flex; gap: 20px; background-color: var(--widget-background); padding: 20px; border-radius: 12px; box-shadow: var(--shadow-widget); margin-bottom: 30px; }
        .controls select { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-size: 1.05em; -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%2...%3E"); background-repeat: no-repeat; background-position: right 15px center; background-size: 12px; }
        .loader { text-align: center; font-weight: bold; font-size: 1.2em; padding: 50px; }
        .rank-card { background-color: var(--widget-background); border-radius: 12px; box-shadow: var(--shadow-widget); margin-bottom: 20px; padding: 25px; }
        .rank-header { border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .rank-title { font-size: 1.5em; font-weight: 600; color: var(--secondary-color); margin: 0; }
        .rank-details { display: flex; align-items: baseline; gap: 15px; margin-top: 5px; }
        .rank-position { font-size: 1.2em; font-weight: bold; }
        .rank-position .top { color: var(--primary-color); }
        .rank-change { display: inline-flex; align-items: center; font-weight: bold; border-radius: 5px; padding: 3px 8px; font-size: 0.9em; }
        .rank-change.up { color: var(--green); background-color: #eafaf1; }
        .rank-change.down { color: var(--red); background-color: #f9ebea; }
        .rank-change.same { color: var(--grey); background-color: #f4f6f7; }
        .rank-change .arrow { font-size: 1.2em; margin-right: 4px; }
    </style>
</head>
<body>

    <div class="site-header-container">
        <a href="main.html" class="back-arrow" title="Retour">←</a>
        <header class="site-header">Classement</header>
    </div>

    <main class="main-content">
        <div class="controls">
            <select id="niveau-selector">
                <option value="sec4">Secondaire 4</option>
                <option value="sec5">Secondaire 5</option>
            </select>
            <select id="terme-selector">
                <option value="Moyenne Générale">Moyenne Générale</option>
                <option value="Moyenne Étape 1">Moyenne Étape 1</option>
                <option value="Moyenne Étape 2">Moyenne Étape 2</option>
                <option value="Français (Étape 1)">Français (Étape 1)</option>
                <option value="Math (Étape 1)">Math (Étape 1)</option>
                <option value="Anglais (Étape 1)">Anglais (Étape 1)</option>
                <option value="Français (Étape 2)">Français (Étape 2)</option>
                <option value="Math (Étape 2)">Math (Étape 2)</option>
                <option value="Anglais (Étape 2)">Anglais (Étape 2)</option>
            </select>
        </div>

        <div id="leaderboard-content">
            <div class="loader">Chargement des données...</div>
        </div>
    </main>
    
    <script>
        const WEB_APP_URL_GET = 'YOUR_WEB_APP_URL_FOR_GET'; // You will need a new URL for GET requests
        const userCode = localStorage.getItem('jdlmUserCode');

        document.addEventListener('DOMContentLoaded', () => {
            const niveauSelector = document.getElementById('niveau-selector');
            const termeSelector = document.getElementById('terme-selector');

            // Set initial value from main page settings if available
            const savedSettings = JSON.parse(localStorage.getItem('jdlmData'))?.settings;
            if (savedSettings?.niveau) {
                niveauSelector.value = savedSettings.niveau;
            }

            fetchLeaderboardData();

            niveauSelector.addEventListener('change', fetchLeaderboardData);
            termeSelector.addEventListener('change', fetchLeaderboardData);
        });
        
        // This function will fetch ALL data from the sheet. We need to update Apps Script.
        async function fetchLeaderboardData() {
            const contentDiv = document.getElementById('leaderboard-content');
            contentDiv.innerHTML = '<div class="loader">Chargement des données...</div>';

            try {
                // We need to create a GET endpoint in our Apps Script
                const response = await fetch(WEB_APP_URL_GET);
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayLeaderboard(data.data);
                } else {
                    contentDiv.innerHTML = `<p>Erreur: ${data.message}</p>`;
                }
            } catch (error) {
                contentDiv.innerHTML = `<p>Erreur de connexion au classement.</p>`;
                console.error(error);
            }
        }

        function displayLeaderboard(allData) {
            const niveau = document.getElementById('niveau-selector').value;
            const terme = document.getElementById('terme-selector').value;
            const contentDiv = document.getElementById('leaderboard-content');
            contentDiv.innerHTML = '';

            const filteredData = allData.filter(row => row.Niveau === niveau && row[terme]);
            
            // Sort descending by the selected term's grade
            filteredData.sort((a, b) => b[terme] - a[terme]);

            const totalParticipants = filteredData.length;
            let userRank = -1;
            let userData = null;

            filteredData.forEach((row, index) => {
                if (row.Code === userCode) {
                    userRank = index + 1;
                    userData = row;
                }
            });

            if (!userData) {
                contentDiv.innerHTML = '<p>Vos données ne sont pas encore dans ce classement. Synchronisez depuis la page principale.</p>';
                return;
            }
            
            // --- Save and Compare Ranks for Stock-like indicator ---
            const rankStorageKey = `jdlmRank_${niveau}_${terme}`;
            const previousRankData = JSON.parse(localStorage.getItem(rankStorageKey));
            
            let rankChange = 'same'; // 'up', 'down', or 'same'
            let changeText = 'Aucun changement';
            let changeArrow = '●';

            if (previousRankData) {
                if (userRank < previousRankData.rank) {
                    rankChange = 'up';
                    changeText = `+${previousRankData.rank - userRank} places`;
                    changeArrow = '▲';
                } else if (userRank > previousRankData.rank) {
                    rankChange = 'down';
                    changeText = `-${userRank - previousRankData.rank} places`;
                    changeArrow = '▼';
                }
            }
            
            // Save current rank for next time
            localStorage.setItem(rankStorageKey, JSON.stringify({ rank: userRank, total: totalParticipants }));
            
            // --- Render the Card ---
            const card = document.createElement('div');
            card.className = 'rank-card';
            card.innerHTML = `
                <div class="rank-header">
                    <h3 class="rank-title">${terme}</h3>
                </div>
                <div class="rank-details">
                    <div class="rank-position">
                        Votre note: <span class="top">${parseFloat(userData[terme]).toFixed(2)}%</span>
                        — Classé <span class="top">${userRank}</span> sur ${totalParticipants}
                    </div>
                    <div class="rank-change ${rankChange}">
                        <span class="arrow">${changeArrow}</span> ${changeText}
                    </div>
                </div>
            `;
            contentDiv.appendChild(card);
        }
    </script>
</body>
</html>
