<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord - Outil JDLM</title>
    <link rel="icon" href="https://raw.githubusercontent.com/Student-broken/student-broken.github.io/refs/heads/main/favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2980b9; --secondary-color: #2c3e50; --side-panel-color: #ffffff;
            --widget-darker-color: #f0f4f7; --background-color: #f7f9fb; --widget-background: #ffffff;
            --text-color: #34495e; --light-grey: #bdc3c7; --footer-grey: #95a5a6;
            --danger-color: #e74c3c; --shadow-header: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-widget: 0 8px 15px rgba(0, 0, 0, 0.08);
        }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--background-color); color: var(--text-color); }
        .site-header-container { background-color: var(--widget-background); box-shadow: var(--shadow-header); border-bottom: 1px solid #e0e6eb; padding: 15px 0; position: relative; margin-bottom: 20px; }
        .site-header { text-align: center; padding: 0; margin: 0; color: var(--secondary-color); font-size: 2.2em; font-weight: 700; font-family: 'Playfair Display', serif; letter-spacing: 0.05em; }
        .main-container { display: flex; max-width: 1600px; margin: 0 auto; padding: 0 20px; align-items: flex-start; gap: 30px; }
        .data-section { flex: 3; }
        .side-panel { flex: 1; position: sticky; top: 20px; background-color: var(--side-panel-color); border-radius: 12px; padding: 25px; box-shadow: var(--shadow-widget); }
        .moyenne-widgets { display: flex; gap: 15px; margin-bottom: 25px; }
        .moyenne-widget { flex: 1; background-color: var(--widget-darker-color); border-radius: 10px; padding: 15px; text-align: center; box-shadow: none; border: 1px solid #e0e6eb; }
        .moyenne-widget h4 { margin: 0 0 8px 0; font-size: 0.85em; color: var(--secondary-color); font-weight: 500; }
        .moyenne-value { font-size: 2.2em; font-weight: bold; color: var(--primary-color); }
        .moyenne-value.invalid { color: var(--danger-color); }
        .control-group { margin-bottom: 20px; }
        .control-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        .control-group select, .control-group .btn { width: 100%; }
        select { padding: 12px; border-radius: 10px; border: 1px solid #ddd; background-color: white; transition: box-shadow 0.2s, border-color 0.2s; -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%2...%3E"); background-repeat: no-repeat; background-position: right 10px top 50%; background-size: 10px auto; }
        select:focus { box-shadow: 0 0 0 3px rgba(41, 128, 185, 0.2); border-color: var(--primary-color); outline: none; }
        .subject-averages { margin-top: 25px; padding-top: 15px; border-top: 1px solid #e0e6eb; }
        .subject-averages h4 { margin-top: 0; color: var(--secondary-color); font-size: 1.1em; margin-bottom: 15px; }
        #subject-averages-list { list-style: none; padding: 0; margin: 0; font-size: 0.9em; }
        #subject-averages-list li { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dotted #e0e0e0; }
        #subject-averages-list li:last-child { border-bottom: none; }
        .btn { display: block; width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 1.05em; font-weight: 600; cursor: pointer; text-decoration: none; color: white; transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .btn-control { background-color: var(--primary-color); }
        .btn-control:hover { background-color: #3498db; }
        .btn-header-action { position: absolute; top: 50%; right: 25px; transform: translateY(-50%); display: inline-block; width: auto; min-width: 180px; padding: 12px 20px; font-size: 0.95em; font-weight: 600; background-color: var(--secondary-color); color: white; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: background-color 0.2s, transform 0.1s; }
        .btn-header-action:hover { background-color: #34495e; transform: translateY(-50%) translateY(-1px); }
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab-btn { padding: 12px 20px; cursor: pointer; border: none; background: none; font-size: 1.05em; font-weight: 600; color: var(--light-grey); position: relative; transition: color 0.2s; }
        .tab-btn:hover { color: var(--secondary-color); }
        .tab-btn.active { color: var(--primary-color); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 3px; background-color: var(--primary-color); border-radius: 2px 2px 0 0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .subject-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 30px; background: var(--widget-background); box-shadow: var(--shadow-widget); border-radius: 12px; overflow: hidden; }
        .subject-table th, .subject-table td { padding: 14px 18px; text-align: left; border-bottom: 1px solid #f0f0f0; vertical-align: top; }
        .subject-table thead tr:first-child th { padding: 18px 18px; font-size: 1.1em; background-color: var(--secondary-color); }
        .subject-table th { background-color: #34495e; color: white; font-size: 14px; }
        .subject-table tbody tr:hover td { background-color: #f7f9fb; }
        .subject-table td { font-size: 13px; }
        .subject-table tr:last-child td { border-bottom: none; }
        .competency-row td { background-color: #eaf2f8; color: var(--secondary-color); font-weight: bold; font-style: italic; border-bottom: 1px solid #d0e0ee; }
        .competency-row:hover td { background-color: #eaf2f8; }
        .no-data { color: var(--light-grey); font-style: italic; }
        .grade-percentage { font-weight: 700; color: #1e8449; }
        footer { text-align: center; padding: 15px; font-size: 0.8em; color: var(--footer-grey); font-style: italic; border-top: 1px solid #eee; margin-top: 20px; }
        .logout-arrow { position: absolute; top: 50%; left: 25px; transform: translateY(-50%); font-size: 2.2em; color: var(--secondary-color); text-decoration: none; line-height: 1; transition: color 0.2s, transform 0.2s; z-index: 10; }
        .logout-arrow:hover { color: var(--primary-color); transform: translateY(-50%) scale(1.05); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: relative; max-width: 90%; width: 450px; transform: translateY(-20px); opacity: 0; transition: transform 0.3s, opacity 0.3s; }
        .modal-overlay.active .modal-content { transform: translateY(0); opacity: 1; }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 2em; cursor: pointer; color: var(--light-grey); line-height: 1; transition: color 0.2s; }
        .modal-close:hover { color: var(--danger-color); }
        #unites-list { max-height: 300px; overflow-y: auto; margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; }
        .unite-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-radius: 6px; }
        .unite-item:nth-child(even) { background-color: #fcfdfe; }
        .unite-item label { flex: 1; font-weight: 500; }
        .unite-item input, .unite-item span { width: 70px; text-align: center; padding: 6px; border: 1px solid #ddd; border-radius: 6px; }
        .unite-item span { background-color: var(--widget-darker-color); font-weight: bold; border: none; }
        .unite-item input:focus { border-color: var(--primary-color); outline: none; }
    </style>
</head>
<body>

    <div class="log-display" style="margin-top: 30px; padding: 15px; border: 1px solid #ccc; background-color: #f9f9f9; display: none;">
    <p>Utilisateur enregistré : <strong id="current-user-display">Anonyme</strong></p>
    <p id="log-status">Tentative d'enregistrement de la visite...</p>
</div>

<script>
    // !! IMPORTANT !! REMPLACEZ CETTE URL PAR VOTRE URL DE DÉPLOIEMENT DE L'APPLICATION WEB LOGGING
    const LOGGING_API_URL = "https://script.google.com/macros/s/AKfycbxMNJ139nMtAxQCakaiNSTBS1DI4gWe3MzjXansflmv7JNNjDXg1xcs4GemNq_eIgPfXA/exec"; 

    // Fonction pour récupérer le nom de l'utilisateur (utilisant la variable 'nom')
    function getUserName() {
        // Tente de récupérer le nom depuis localStorage.
        try {
            const userData = JSON.parse(localStorage.getItem('jdlmData'));
            
            // On vérifie que userData existe et que la propriété 'nom' existe et n'est pas vide
            if (userData && userData.nom && userData.nom.trim() !== "") {
                return userData.nom;
            }
        } catch (e) {
            // Ignorer l'erreur si localStorage est inaccessible ou corrompu
        }
        // Retourne 'Anonyme' si aucune donnée valide n'est trouvée
        return 'Anonyme'; 
    }

    // Fonction principale pour enregistrer la visite
    async function logUserVisit() {
        const userName = getUserName();
        const logStatus = document.getElementById('log-status');
        const userDisplay = document.getElementById('current-user-display');

        // Mise à jour de l'affichage utilisateur (peut être Anonyme)
        userDisplay.textContent = userName;

        if (LOGGING_API_URL === "VOTRE_LOGGING_API_URL_ICI" || LOGGING_API_URL.includes("VOTRE_LOGGING_API_URL_ICI")) {
            logStatus.textContent = "Erreur: Veuillez définir l'URL de l'API Logging.";
            return;
        }

        try {
            // Envoi du nom d'utilisateur (qui sera 'Anonyme' si non trouvé) au paramètre 'name' de l'Apps Script
            const fullUrl = `${LOGGING_API_URL}?name=${encodeURIComponent(userName)}`;

            const response = await fetch(fullUrl, {
                method: 'GET',
                mode: 'cors' 
            });
            
            if (!response.ok) {
                throw new Error(`Erreur réseau: Statut ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
                // Si l'enregistrement est réussi, affiche l'heure locale du client
                const now = new Date();
                const dateStr = now.toLocaleDateString('fr-CA', { year: 'numeric', month: 'long', day: 'numeric' });
                const timeStr = now.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                
                logStatus.innerHTML = `Visite enregistrée le <strong>${dateStr}</strong> à <strong>${timeStr}</strong>.`;
            } else {
                logStatus.textContent = "Échec de l'enregistrement de la visite (Réponse API non réussie).";
            }

        } catch (error) {
            console.error("Erreur lors de l'enregistrement de la visite :", error);
            logStatus.innerHTML = `Erreur de connexion au serveur d'enregistrement. Vérifiez la console pour les erreurs CORS ou réseau : <strong>${error.message}</strong>`;
        }
    }

    // Déclencher la fonction d'enregistrement au chargement complet de la page
    document.addEventListener('DOMContentLoaded', logUserVisit);
</script>
    <div class="site-header-container">
        <a href="index.html" class="logout-arrow" title="Déconnexion">←</a>
        <header class="site-header">Outil JDLM*</header>
        <a href="data.html" class="btn btn-header-action">Ajouter des données</a>
    </div>
    <main class="main-container">
        <section class="data-section">
            <div class="tabs">
                <button class="tab-btn active" data-tab="etape1">Étape 1</button>
                <button class="tab-btn" data-tab="etape2">Étape 2</button>
                <button class="tab-btn" data-tab="etape3">Étape 3</button>
            </div>
            <div id="tab-contents">
                <div id="etape1" class="tab-content active"></div>
                <div id="etape2" class="tab-content"></div>
                <div id="etape3" class="tab-content"></div>
            </div>
        </section>
        <aside class="side-panel">
            <div class="moyenne-widgets">
                <div class="moyenne-widget"><h4>Moyenne générale</h4><div id="moyenne-generale" class="moyenne-value">--</div></div>
                <div class="moyenne-widget"><h4>Moyenne de l'étape</h4><div id="moyenne-etape" class="moyenne-value">--</div></div>
            </div>
            <div class="control-group">
                <select id="niveau-secondaire"><option value="">-- Niveau --</option><option value="sec4">Secondaire 4</option><option value="sec5">Secondaire 5</option></select>
            </div>
            <div class="control-group"><button id="unites-btn" class="btn btn-control">Unités</button></div>
            <div class="control-group"><button id="classement-btn" class="btn btn-control" onclick="window.location.href='classement.html'">Classement</button></div>

            <div class="subject-averages">
                <h4>Moyennes par matière</h4>
                <ul id="subject-averages-list"><li class="no-data">Aucune donnée</li></ul>
            </div>
        </aside>
    </main>
    <div class="modal-overlay" id="unites-modal">
        <div class="modal-content">
            <span class="modal-close" id="close-unites-modal">&times;</span><h3>Unités</h3>
            <div class="control-group"><select id="unites-mode"><option value="defaut">Unités défaut</option><option value="sans">Sans unités</option><option value="perso">Personnalisée</option></select></div>
            <div id="unites-list"></div>
        </div>
    </div>
    <footer>
    <p>*jauge de la moyenne</p>
    <p style="font-style: normal; margin-top: 8px;">
        Pour toute question, préoccupation ou pour signaler un bogue, veuillez contacter : 
        <a href="mailto:notabot.chat@gmail.com" style="font-style: normal;">notabot.chat@gmail.com</a>
    </p>
</footer>

    <script>
        // --- YOUR EXISTING SCRIPT FOR CALCULATIONS AND RENDERING (UNCHANGED) ---
        const gradeMap = { 'A+': {min: 100, max: 100}, 'A': {min: 95, max: 95}, 'A-': {min: 90, max: 90}, 'B+': {min: 85, max: 85}, 'B': {min: 80, max: 80}, 'B-': {min: 75, max: 75}, 'C+': {min: 70, max: 70}, 'C': {min: 65, max: 65}, 'C-': {min: 60, max: 60}, 'D+': {min: 55, max: 55}, 'D': {min: 50, max: 50}, 'E': {min: 45, max: 45} };
        const defaultUnits = { sec4: { 'ART': 2, 'MUS': 2, 'DRM': 2, 'FRA': 6, 'ELA': 4, 'EESL': 6, 'ESL': 4, 'MAT': 6, 'CST': 6, 'ST': 4, 'STE': 4, 'HQC': 4, 'CCQ': 2, 'EPS': 2, 'ENT': 2, 'INF': 2, 'PSY': 2, }, sec5: { 'ART': 2, 'MUS': 2, 'DRM': 2, 'CAT': 4, 'FRA': 6, 'ELA': 6, 'EESL': 6, 'ESL': 4, 'MAT': 6, 'CST': 4, 'MED': 4, 'PSY': 4, 'ENT': 4, 'FIN': 4, 'CHI': 4, 'PHY': 4, 'MON': 2, 'HQC': 4, 'CCQ': 2, 'EPS': 2, 'FIN': 2 } };
        const subjectList = { 'ART': "Arts Plastiques", 'MUS': "Musique", 'DRM': "Art Dramatique", 'CAT': "Conception et Application Technologique", 'FRA': "Français", 'ELA': "English Language Arts", 'EESL': "Enriched English", 'ESL': "English Second Language", 'SN': "Math SN", 'CST': "Math CST", 'ST': "Science et Technologie", 'STE': "Science et Tech. Env.", 'HQC': "Histoire", 'CCQ': "Culture et Citoyenneté", 'EPS': "Éducation Physique", 'CHI': "Chimie", 'PHY': "Physique", 'MON': "Monde Contemporain", 'MED': "Média", 'ENT': "Entrepreneuriat", 'INF': "Informatique", 'PSY': "Psychologie", 'FIN': "Éducation Financière", };
        let jdlmData, activeTab = 'etape1';
        
        document.addEventListener('DOMContentLoaded', () => { 
            checkLogoutTimer(); 
            jdlmData = JSON.parse(localStorage.getItem('jdlmData')) || {}; 
            if (!jdlmData.nom) { 
                document.getElementById('tab-contents').innerHTML = "<p>Aucune donnée disponible. Veuillez ajouter les données.</p>"; 
                return; 
            } 
            localStorage.setItem('jdlmLastActive', Date.now().toString()); 
            loadSettings(); 
            setupEventListeners(); 
            renderAll();
        });

        function checkLogoutTimer() { const lastActiveTime = localStorage.getItem('jdlmLastActive'); const ONE_HOUR = 3600000; if (lastActiveTime && (Date.now() - parseInt(lastActiveTime)) > ONE_HOUR) { window.location.href = 'index.html'; } setInterval(() => { const checkTime = localStorage.getItem('jdlmLastActive'); if (checkTime && (Date.now() - parseInt(checkTime)) > ONE_HOUR) { window.location.href = 'index.html'; } }, 300000); }
        
        function setupEventListeners() { 
            document.querySelectorAll('.tab-btn').forEach(tab => { tab.addEventListener('click', () => { document.querySelector('.tab-btn.active').classList.remove('active'); tab.classList.add('active'); document.querySelector('.tab-content.active').classList.remove('active'); activeTab = tab.dataset.tab; document.getElementById(activeTab).classList.add('active'); renderSidePanel(); }); }); 
            
            document.getElementById('niveau-secondaire').addEventListener('change', (e) => { 
                jdlmData.settings = { ...jdlmData.settings, niveau: e.target.value }; 
                localStorage.setItem('jdlmData', JSON.stringify(jdlmData)); 
                renderAll(); 
            }); 

            // --- NEW LOGIC: Event Listener for the "Classement" button ---
            document.getElementById('classement-btn').addEventListener('click', function(event) {
                // Try to send the data. The function will return true or false.
                const canProceed = sendRankingData();
                
                // If the function returns false (because data is missing),
                // prevent the link from navigating.
                if (!canProceed) {
                    event.preventDefault();
                }
            });

            const unitesModal = document.getElementById('unites-modal'); 
            document.getElementById('unites-btn').addEventListener('click', () => { populateUnitesModal(); unitesModal.classList.add('active'); }); 
            document.getElementById('close-unites-modal').addEventListener('click', () => { saveCustomUnits(); unitesModal.classList.remove('active'); renderAll(); }); 
            unitesModal.addEventListener('click', (e) => { if(e.target === unitesModal) { saveCustomUnits(); unitesModal.classList.remove('active'); renderAll(); } }); 
            document.getElementById('unites-mode').addEventListener('change', (e) => { jdlmData.settings = { ...jdlmData.settings, unitesMode: e.target.value }; localStorage.setItem('jdlmData', JSON.stringify(jdlmData)); populateUnitesModal(); }); 
        }
        
        function loadSettings() { const settings = jdlmData.settings || {}; document.getElementById('niveau-secondaire').value = settings.niveau || ''; document.getElementById('unites-mode').value = settings.unitesMode || 'defaut'; }
        function saveCustomUnits() { if (document.getElementById('unites-mode').value !== 'perso') return; let customUnites = {}; document.querySelectorAll('.unite-item input').forEach(input => { customUnites[input.dataset.code] = parseFloat(input.value) || 1; }); jdlmData.settings.customUnites = customUnites; localStorage.setItem('jdlmData', JSON.stringify(jdlmData)); }
        function getNumericGrade(result) { if (!result) return null; const trimmedResult = result.trim(); if (gradeMap[trimmedResult]) { const { min, max } = gradeMap[trimmedResult]; return (min + max) / 2; } const scoreMatch = trimmedResult.match(/(\d+[,.]?\d*)\s*\/\s*(\d+[,.]?\d*)/); if (scoreMatch) { const score = parseFloat(scoreMatch[1].replace(',', '.')); const maxScore = parseFloat(scoreMatch[2].replace(',', '.')); if (!isNaN(score) && !isNaN(maxScore) && maxScore > 0) { return (score / maxScore) * 100; } } return null; }
        function calculateSubjectAverage(subject) { let totalWeightedGrade = 0; let totalCompetencyWeight = 0; subject.competencies.forEach(comp => { const compWeightMatch = comp.name.match(/\((\d+)%\)/); if (!compWeightMatch) return; const compWeight = parseFloat(compWeightMatch[1]); let totalAssignmentGrade = 0; let totalAssignmentWeight = 0; comp.assignments.forEach(assign => { const grade = getNumericGrade(assign.result); const weight = parseFloat(assign.pond); if (grade !== null && !isNaN(weight)) { totalAssignmentGrade += grade * weight; totalAssignmentWeight += weight; } }); if (totalAssignmentWeight > 0) { const competencyAverage = totalAssignmentGrade / totalAssignmentWeight; totalWeightedGrade += competencyAverage * compWeight; totalCompetencyWeight += compWeight; } }); return totalCompetencyWeight > 0 ? totalWeightedGrade / totalCompetencyWeight : null; }
        function getUnits() { const settings = jdlmData.settings || {}; const niveau = settings.niveau; const mode = settings.unitesMode || 'defaut'; if (mode === 'sans') return new Proxy({}, { get: () => 1 }); if (mode === 'perso') return settings.customUnites || {}; if (mode === 'defaut' && niveau && defaultUnits[niveau]) { return defaultUnits[niveau]; } return {}; }
        function calculateAverages() { const units = getUnits(); const settings = jdlmData.settings || {}; const niveau = settings.niveau; const mode = settings.unitesMode || 'defaut'; let allTermAverages = {}; let allSubjectAverages = {}; const defaultSubjectUnit = 2; ['etape1', 'etape2', 'etape3'].forEach(etape => { if (!jdlmData[etape]) return; let termWeightedSum = 0; let termUnitSum = 0; allSubjectAverages[etape] = {}; jdlmData[etape].forEach(subject => { const average = calculateSubjectAverage(subject); const codePrefix = subject.code.substring(0,3); allSubjectAverages[etape][codePrefix] = { name: subjectList[codePrefix] || subject.name, average: average }; let unit; if (mode === 'defaut' && !niveau) { unit = null; } else if (mode === 'sans' || mode === 'perso') { unit = units[codePrefix] ?? 1; } else if (mode === 'defaut') { unit = units[codePrefix] ?? defaultSubjectUnit; } if (average !== null && unit !== null && niveau) { termWeightedSum += average * unit; termUnitSum += unit; } }); allTermAverages[etape] = termUnitSum > 0 ? termWeightedSum / termUnitSum : null; }); let globalWeightedSum = 0; let globalTermCount = 0; Object.values(allTermAverages).forEach(avg => { if (avg !== null) { globalWeightedSum += avg; globalTermCount++; } }); return { subjectAverages: allSubjectAverages, termAverages: allTermAverages, globalAverage: globalTermCount > 0 ? globalWeightedSum / globalTermCount : null }; }
        function renderAll() { renderTermTables(); renderSidePanel(); }
        function renderTermTables() { renderTermData(jdlmData.etape1, document.getElementById('etape1')); renderTermData(jdlmData.etape2, document.getElementById('etape2')); renderTermData(jdlmData.etape3, document.getElementById('etape3')); }
        function renderSidePanel() { const averages = calculateAverages(); const niveau = (jdlmData.settings || {}).niveau; const globalAvgEl = document.getElementById('moyenne-generale'); const termAvgEl = document.getElementById('moyenne-etape'); globalAvgEl.classList.toggle('invalid', !niveau); termAvgEl.classList.toggle('invalid', !niveau); const formatAvg = (avg) => avg !== null ? `<span class="grade-percentage">${avg.toFixed(2)}%</span>` : '--'; globalAvgEl.innerHTML = !niveau ? 'N/A' : formatAvg(averages.globalAverage); termAvgEl.innerHTML = !niveau ? 'N/A' : formatAvg(averages.termAverages[activeTab]); const subjectListEl = document.getElementById('subject-averages-list'); subjectListEl.innerHTML = ''; const activeTermSubjects = averages.subjectAverages[activeTab]; if (activeTermSubjects && Object.keys(activeTermSubjects).length > 0) { Object.entries(activeTermSubjects).forEach(([code, subj]) => { const li = document.createElement('li'); li.innerHTML = `<span>${subj.name}</span><strong>${formatAvg(subj.average)}</strong>`; subjectListEl.appendChild(li); }); } else { subjectListEl.innerHTML = '<li class="no-data">Aucune matière pour cette étape</li>'; } }
        function populateUnitesModal() { const listContainer = document.getElementById('unites-list'); const mode = document.getElementById('unites-mode').value; const settings = jdlmData.settings || {}; listContainer.innerHTML = ''; const allSubjects = new Map(); ['etape1', 'etape2', 'etape3'].forEach(etape => { if (jdlmData[etape]) { jdlmData[etape].forEach(subject => { const codePrefix = subject.code.substring(0,3); if (!allSubjects.has(codePrefix)) { allSubjects.set(codePrefix, subjectList[codePrefix] || subject.name); } }); } }); if (allSubjects.size === 0) { listContainer.innerHTML = '<div class="no-data">Aucune matière trouvée.</div>'; return; } const units = getUnits(); const defaultSubjectUnit = 2; allSubjects.forEach((name, code) => { const item = document.createElement('div'); item.className = 'unite-item'; let valueDisplay = ''; if (mode === 'perso') { const currentValue = (settings.customUnites || {})[code] || 1; valueDisplay = `<input type="number" data-code="${code}" value="${currentValue}" min="0" step="1">`; } else { let unitValue; if (mode === 'sans') { unitValue = 1; } else if (mode === 'defaut') { unitValue = units[code] ?? defaultSubjectUnit; } valueDisplay = `<span>${unitValue}</span>`; } item.innerHTML = `<label>${name} (${code})</label>${valueDisplay}`; listContainer.appendChild(item); }); }
        function renderTermData(termData, container) { container.innerHTML = ''; if (!termData || termData.length === 0) { container.innerHTML = '<p class="no-data">Aucune donnée pour cette étape.</p>'; return; } termData.forEach(subject => container.appendChild(renderSubjectTable(subject))); }
        function renderSubjectTable(subject) { const table = document.createElement('table'); table.className = 'subject-table'; table.innerHTML = `<thead><tr><th colspan="7">${subject.code} - ${subject.name}</th></tr><tr><th>Catégorie</th><th>Travail</th><th>Pond.</th><th>Date assignée</th><th>Date due</th><th>Date complétée</th><th>Résultat</th></tr></thead><tbody></tbody>`; const tbody = table.querySelector('tbody'); subject.competencies.forEach(comp => { const compRow = document.createElement('tr'); compRow.className = 'competency-row'; compRow.innerHTML = `<td colspan="7">${comp.name}</td>`; tbody.appendChild(compRow); comp.assignments.forEach(assign => { const assignRow = document.createElement('tr'); const numGrade = getNumericGrade(assign.result); let formattedResult = '<span class="no-data">-</span>'; if (assign.result) { const isLetterGrade = !!gradeMap[assign.result.trim()]; const isSimplePercentage = assign.result.includes('%') && !assign.result.includes('/'); if (isLetterGrade && numGrade !== null) { formattedResult = `${assign.result} <i>(~<span class="grade-percentage">${numGrade.toFixed(1)}%</span>)</i>`; } else if (isSimplePercentage || assign.result.match(/(\d+[,.]?\d*)\s*\/\s*(\d+[,.]?\d*)/)) { formattedResult = assign.result.replace(/(\d+[,.]?\d*\s*\/.*|(\d+[,.]?\d*\s*%))/g, (match) => `<span class="grade-percentage">${match}</span>`); } else { formattedResult = assign.result; } } assignRow.innerHTML = `<td>${assign.category || '<span class="no-data">-</span>'}</td><td>${assign.work || '<span class="no-data">-</span>'}</td><td>${assign.pond || '<span class="no-data">-</span>'}</td><td>${assign.assignedDate || '<span class="no-data">-</span>'}</td><td>${assign.dueDate.replace('à','') || '<span class="no-data">-</span>'}</td><td>${assign.completedDate || '<span class="no-data">-</span>'}</td><td>${formattedResult}</td>`; tbody.appendChild(assignRow); }); }); return table; }

        // =======================================================
        // START: FINAL RANKING SCRIPT WITH TIMESTAMP
        // =======================================================

        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxOay6sGNlL_f4MfhHkmwBTi0J3ONrCxv2dg1y5pqKjgKmAN07xttJtlrXjNqLbxdYR/exec";

        /**
         * Checks for a stored anonymous user code or generates a new one.
         * This ensures user privacy by not using their real name.
         * @returns {string} The anonymous user code.
         */
        function getUserCode() {
            // Check if jdlmData and a userCode already exist.
            if (jdlmData && jdlmData.userCode) {
                return jdlmData.userCode;
            }

            // If not, generate a new anonymous code.
            // Example: "user" + timestamp + random number
            const newCode = 'user' + Date.now() + Math.floor(Math.random() * 1000);

            // Ensure the jdlmData object exists before modification.
            if (!jdlmData) {
                jdlmData = {};
            }
            jdlmData.userCode = newCode;

            // Persist the updated data with the new anonymous code back to localStorage.
            try {
                localStorage.setItem('jdlmData', JSON.stringify(jdlmData));
            } catch (error) {
                console.error("Could not save anonymous user code to localStorage:", error);
            }

            return newCode;
        }

        function getAggregatedSubjectAverage(allSubjectAverages, subjectCodes) {
            let totalSum = 0;
            let count = 0;
            ['etape1', 'etape2', 'etape3'].forEach(etape => {
                if (allSubjectAverages[etape]) {
                    Object.entries(allSubjectAverages[etape]).forEach(([code, subjectData]) => {
                        if (subjectCodes.includes(code) && subjectData.average !== null) {
                            totalSum += subjectData.average;
                            count++;
                        }
                    });
                }
            });
            return count > 0 ? totalSum / count : null;
        }

        /**
         * This is the primary function triggered before going to the dashboard.
         * It validates, prepares, and sends data.
         * @returns {boolean} - Returns true if sending is successful, false otherwise.
         */
        function sendRankingData() {
            const niveau = document.getElementById('niveau-secondaire').value;
            const userCode = getUserCode();

            // 1. Validate that necessary data exists.
            if (!userCode) {
                alert("Erreur: L'identifiant utilisateur n'a pas pu être généré. Impossible de continuer.");
                return false; // Block navigation
            }
            if (!niveau) {
                alert("Veuillez sélectionner votre niveau (Secondaire 4 ou 5) avant de consulter le classement.");
                return false; // Block navigation
            }
            
            console.log(`Validation successful. Preparing to send data for user '${userCode}'...`);

            // 2. Save the selected level for the classement page to use.
            localStorage.setItem('jdlmNiveau', niveau);

            // 3. Prepare data payload.
            const averages = calculateAverages();
            const mathAvg = getAggregatedSubjectAverage(averages.subjectAverages, ['MAT', 'CST', 'SN']);
            const englishAvg = getAggregatedSubjectAverage(averages.subjectAverages, ['ELA', 'ESL', 'EESL']);
            const frenchAvg = getAggregatedSubjectAverage(averages.subjectAverages, ['FRA']);

            const formData = new FormData();
            formData.append('userCode', userCode);
            formData.append('niveau', niveau);
            formData.append('avg_generale', averages.globalAverage ? averages.globalAverage.toFixed(2) : '');
            formData.append('avg_etape1', averages.termAverages.etape1 ? averages.termAverages.etape1.toFixed(2) : '');
            formData.append('avg_etape2', averages.termAverages.etape2 ? averages.termAverages.etape2.toFixed(2) : '');
            formData.append('avg_etape3', averages.termAverages.etape3 ? averages.termAverages.etape3.toFixed(2) : '');
            formData.append('avg_math', mathAvg ? mathAvg.toFixed(2) : '');
            formData.append('avg_anglais', englishAvg ? englishAvg.toFixed(2) : '');
            formData.append('avg_francais', frenchAvg ? frenchAvg.toFixed(2) : '');
            
            // 4. Add the new timestamp.
            formData.append('last_updated', new Date().toISOString());
            
            // 5. Send the data.
            fetch(SCRIPT_URL, { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                if(data.result === 'success') console.log("Data sent and updated successfully:", data.userCode);
                else console.error("Script Error:", data.error);
            })
            .catch(error => console.error("Network Error:", error));

            // 6. Allow navigation to proceed.
            return true;
        }
    </script>
</body>
</html>
